name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (leave as "auto" to detect from changelog)'
        required: true
        type: choice
        default: auto
        options:
          - auto
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (preview changes without committing)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  # Validate before release
  validate:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Generate API types
        run: npm run generate:api

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

  release:
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      release_notes: ${{ steps.changelog.outputs.release_notes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(node -p "require('./web-app/package.json').version")
          echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Current version: $CURRENT_VERSION"

      - name: Extract unreleased changes
        id: unreleased
        run: |
          # Extract content between [Unreleased] and the next version header
          UNRELEASED=$(sed -n '/^## \[Unreleased\]/,/^## \[/p' CHANGELOG.md | sed '1d;$d')

          if [ -z "$(echo "$UNRELEASED" | sed '/^$/d')" ]; then
            echo "::error::No unreleased changes found in CHANGELOG.md"
            exit 1
          fi

          # Save to file for later use
          echo "$UNRELEASED" > /tmp/unreleased.md
          echo "Found unreleased changes"

          # Detect version bump type from changelog content
          # Priority: BREAKING > Added > everything else

          # Check for breaking changes (BREAKING: or [BREAKING] markers)
          if echo "$UNRELEASED" | grep -qiE '(BREAKING:|BREAKING CHANGE:|\[BREAKING\])'; then
            echo "type=major" >> "$GITHUB_OUTPUT"
            echo "Detected: MAJOR (breaking changes found)"
          # Check for new features (### Added section with content)
          elif echo "$UNRELEASED" | sed -n '/^### Added/,/^### /p' | grep -qE '^- '; then
            echo "type=minor" >> "$GITHUB_OUTPUT"
            echo "Detected: MINOR (new features in Added section)"
          # Default to patch (bug fixes, changes, etc.)
          else
            echo "type=patch" >> "$GITHUB_OUTPUT"
            echo "Detected: PATCH (bug fixes or minor changes)"
          fi

      - name: Determine version type
        id: version_type
        run: |
          INPUT_TYPE="${{ inputs.version_type }}"
          DETECTED_TYPE="${{ steps.unreleased.outputs.type }}"

          if [ "$INPUT_TYPE" = "auto" ]; then
            echo "type=$DETECTED_TYPE" >> "$GITHUB_OUTPUT"
            echo "Using auto-detected version type: $DETECTED_TYPE"
          else
            echo "type=$INPUT_TYPE" >> "$GITHUB_OUTPUT"
            echo "Using manually specified version type: $INPUT_TYPE"
          fi

      - name: Calculate new version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          TYPE="${{ steps.version_type.outputs.type }}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "$TYPE" in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
          esac

          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "type=$TYPE" >> "$GITHUB_OUTPUT"
          echo "Version bump: $CURRENT -> $NEW_VERSION ($TYPE)"

      - name: Update CHANGELOG.md
        id: changelog
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          CURRENT="${{ steps.current.outputs.version }}"
          DATE=$(date +%Y-%m-%d)
          REPO="${{ github.repository }}"

          # Save release notes for GitHub release
          cp /tmp/unreleased.md /tmp/release_notes.md
          echo "notes_file=/tmp/release_notes.md" >> "$GITHUB_OUTPUT"

          # Update the changelog using awk:
          # 1. After [Unreleased] header, insert new version section
          # 2. Update the comparison links at the bottom
          awk -v version="$VERSION" -v date="$DATE" -v repo="$REPO" -v current="$CURRENT" '
            /^## \[Unreleased\]/ {
              print $0
              print ""
              print "## [" version "] - " date
              in_unreleased = 1
              next
            }
            /^## \[/ && in_unreleased {
              in_unreleased = 0
            }
            /^\[Unreleased\]:/ {
              print "[Unreleased]: https://github.com/" repo "/compare/v" version "...HEAD"
              print "[" version "]: https://github.com/" repo "/compare/v" current "...v" version
              next
            }
            { print }
          ' CHANGELOG.md > /tmp/changelog_updated.md

          mv /tmp/changelog_updated.md CHANGELOG.md
          echo "Updated CHANGELOG.md for version $VERSION"

      - name: Update package.json version
        working-directory: web-app
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          npm version "$VERSION" --no-git-tag-version --allow-same-version
          echo "Updated package.json to version $VERSION"

      - name: Update package-lock.json
        working-directory: web-app
        run: |
          npm install --package-lock-only
          echo "Updated package-lock.json"

      - name: Show changes (dry run)
        if: ${{ inputs.dry_run }}
        run: |
          echo "=== Version bump ==="
          echo "Type: ${{ steps.bump.outputs.type }}"
          echo "New version: ${{ steps.bump.outputs.version }}"
          echo ""
          echo "=== CHANGELOG.md changes ==="
          git diff CHANGELOG.md
          echo ""
          echo "=== package.json changes ==="
          git diff web-app/package.json
          echo ""
          echo "=== Release notes ==="
          cat /tmp/release_notes.md
          echo ""
          echo "=== Would create tag: v${{ steps.bump.outputs.version }} ==="

      - name: Commit changes
        if: ${{ !inputs.dry_run }}
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          git add CHANGELOG.md web-app/package.json web-app/package-lock.json
          git commit -m "$(cat <<'EOF'
          chore(release): prepare v${{ steps.bump.outputs.version }} release
          EOF
          )"

      - name: Create tag
        if: ${{ !inputs.dry_run }}
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          git tag -a "v$VERSION" -m "Release v$VERSION"

      - name: Push changes
        if: ${{ !inputs.dry_run }}
        run: |
          git push origin main
          git push origin "v${{ steps.bump.outputs.version }}"

      - name: Create GitHub Release
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          NOTES_FILE="${{ steps.changelog.outputs.notes_file }}"

          # Create release with notes from changelog
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --notes-file "$NOTES_FILE"

          echo "Created GitHub release v$VERSION"

      - name: Summary
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          TYPE="${{ steps.bump.outputs.type }}"

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "## Dry Run Complete" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Version type | $TYPE |" >> "$GITHUB_STEP_SUMMARY"
            echo "| New version | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Auto-detected | ${{ inputs.version_type == 'auto' && 'Yes' || 'No' }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Release Notes Preview" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/release_notes.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Release Complete" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Version type | $TYPE |" >> "$GITHUB_STEP_SUMMARY"
            echo "| New version | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> "$GITHUB_STEP_SUMMARY"
          fi
