name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (preview changes without committing)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  # Validate before release
  validate:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Generate API types
        run: npm run generate:api

      - name: Lint
        run: npm run lint

      - name: Knip (dead code detection)
        run: npm run knip

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

  release:
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      released: ${{ steps.get_version.outputs.released }}
    steps:
      - name: Verify RELEASE_TOKEN is configured
        env:
          RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          if [ -z "$RELEASE_TOKEN" ]; then
            echo "::error::RELEASE_TOKEN secret is not configured."
            echo "::error::This token is required to bypass branch protection rules."
            echo "::error::See: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens"
            exit 1
          fi
          echo "RELEASE_TOKEN is configured"

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install root dependencies (changesets)
        run: npm install

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Check for changesets
        id: check_changesets
        run: |
          # Count changeset files (excluding config.json and README.md)
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" | wc -l)
          echo "changeset_count=$CHANGESET_COUNT" >> "$GITHUB_OUTPUT"

          if [ "$CHANGESET_COUNT" -eq 0 ]; then
            echo "::warning::No changesets found. Nothing to release."
          else
            echo "Found $CHANGESET_COUNT changeset(s)"
          fi

      - name: Version packages (Changesets)
        if: steps.check_changesets.outputs.changeset_count != '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Temporarily add workspaces for changesets to find web-app
          # (workspaces not in package.json to avoid npm ci issues in CI)
          node -e "
            const pkg = require('./package.json');
            pkg.workspaces = ['web-app'];
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # Run changeset version
          # web-app/CHANGELOG.md is a symlink to ../CHANGELOG.md
          npx changeset version

          # Remove workspaces from package.json
          node -e "
            const pkg = require('./package.json');
            delete pkg.workspaces;
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Get new version
        id: get_version
        run: |
          if [ "${{ steps.check_changesets.outputs.changeset_count }}" -eq 0 ]; then
            echo "released=false" >> "$GITHUB_OUTPUT"
            echo "version=" >> "$GITHUB_OUTPUT"
          else
            VERSION=$(node -p "require('./web-app/package.json').version")
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "released=true" >> "$GITHUB_OUTPUT"
            echo "New version: $VERSION"
          fi

      - name: Extract release notes
        if: steps.get_version.outputs.released == 'true'
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Extract content between the new version header and the next version header
          # This gets the release notes for the version we're releasing
          # Supports both formats:
          #   - Changesets format: "## 1.3.0" (no brackets)
          #   - Keep a Changelog format: "## [1.2.0] - date" (with brackets and date)
          NOTES=$(awk -v ver="$VERSION" '
            BEGIN { printing=0 }
            /^## / {
              if (printing) { exit }
              # Match: "## 1.3.0" or "## [1.3.0]" (with optional date suffix)
              if (index($0, "## " ver) == 1 || index($0, "## [" ver "]") == 1) {
                printing=1
                next
              }
            }
            printing { print }
          ' CHANGELOG.md)

          # Write to file for GitHub release
          echo "$NOTES" > /tmp/release_notes.md

          echo "Release notes extracted for v$VERSION"

      - name: Show changes (dry run)
        if: inputs.dry_run && steps.get_version.outputs.released == 'true'
        run: |
          echo "=== Version bump ==="
          echo "New version: ${{ steps.get_version.outputs.version }}"
          echo ""
          echo "=== CHANGELOG.md changes ==="
          git diff CHANGELOG.md
          echo ""
          echo "=== package.json changes ==="
          git diff web-app/package.json
          echo ""
          echo "=== Release notes ==="
          cat /tmp/release_notes.md
          echo ""
          echo "=== Would create tag: v${{ steps.get_version.outputs.version }} ==="

      - name: Commit changes
        if: ${{ !inputs.dry_run && steps.get_version.outputs.released == 'true' }}
        run: |
          git add .
          git commit -m "$(cat <<'EOF'
          chore(release): prepare v${{ steps.get_version.outputs.version }} release
          EOF
          )"

      - name: Create tag
        if: ${{ !inputs.dry_run && steps.get_version.outputs.released == 'true' }}
        run: git tag -a "v${{ steps.get_version.outputs.version }}" -m "Release v${{ steps.get_version.outputs.version }}"

      - name: Push changes
        if: ${{ !inputs.dry_run && steps.get_version.outputs.released == 'true' }}
        run: |
          git push origin ${{ github.event.repository.default_branch }}
          git push origin "v${{ steps.get_version.outputs.version }}"

      - name: Create GitHub Release
        if: ${{ !inputs.dry_run && steps.get_version.outputs.released == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          gh release create "v${{ steps.get_version.outputs.version }}" \
            --title "v${{ steps.get_version.outputs.version }}" \
            --notes-file /tmp/release_notes.md

      - name: Summary
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          RELEASED="${{ steps.get_version.outputs.released }}"

          if [ "$RELEASED" != "true" ]; then
            echo "## No Release" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No changesets found. Nothing to release." >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "## Dry Run Complete" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| New version | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Release Notes Preview" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/release_notes.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Release Complete" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| New version | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> "$GITHUB_STEP_SUMMARY"
          fi
