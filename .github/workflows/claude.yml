name: Claude Code
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            CRITICAL REQUIREMENT: Before doing ANY work, you MUST read and strictly follow the CLAUDE.md file in the repository root.

            The CLAUDE.md file contains mandatory project guidelines including:
            - Code philosophy and naming conventions
            - React best practices (React 19 patterns, no outdated isMountedRef, etc.)
            - Common anti-patterns to avoid (magic numbers, index keys, memory leaks, race conditions)
            - Testing requirements
            - API integration patterns
            - Accessibility requirements
            - CI validation commands that MUST pass
            - Definition of Done criteria

            VERIFICATION CHECKLIST - Before completing any task:
            1. ✅ Read CLAUDE.md first
            2. ✅ Follow all naming conventions (PascalCase components, camelCase hooks, etc.)
            3. ✅ No magic numbers - use named constants
            4. ✅ No array index as React keys
            5. ✅ Clean up all intervals/timeouts/subscriptions
            6. ✅ Use modern React 18+ patterns (no isMountedRef)
            7. ✅ Run full CI validation: npm run generate:api && npm run lint && npm test && npm run build
            8. ✅ Ensure accessibility (ARIA attributes, keyboard navigation)

            If your changes don't meet these guidelines, fix them before completing the task.
          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
          # Allow Claude to use npm commands for running tests, builds, and linting
          allowed_tools: |
            Bash(npm:*)
            # gh CLI for basic issue/PR operations (view, list, comment)
            Bash(gh issue create:*)
            Bash(gh issue edit:*)
            Bash(gh issue list:*)
            Bash(gh issue comment:*)
            Bash(gh issue view:*)
            Bash(gh pr view:*)
            Bash(gh pr diff:*)
            Bash(gh pr comment:*)
            Bash(gh pr list:*)
            # MCP GitHub tools for advanced operations (create/update, PR reviews, line-level comments)
            mcp__github__issue_read
            mcp__github__issue_write
            mcp__github__add_issue_comment
            mcp__github__pull_request_read
            mcp__github__pull_request_review_write
            mcp__github__add_comment_to_pending_review
