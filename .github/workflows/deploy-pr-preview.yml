name: Deploy PR Preview
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'web-app/**'
      - 'ocr-poc/**'
      - 'help-site/**'
      - '.github/workflows/deploy-pr-preview.yml'
permissions:
  contents: write
  pull-requests: write
concurrency:
  group: 'pages'
  cancel-in-progress: false
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            web-app/package-lock.json
            ocr-poc/package-lock.json
            help-site/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Cache generated API types
        id: api-cache
        uses: actions/cache@v4
        with:
          path: web-app/src/api/schema.ts
          key: api-types-${{ hashFiles('docs/api/volleymanager-openapi.yaml', 'web-app/package-lock.json') }}
      - name: Generate API types
        if: steps.api-cache.outputs.cache-hit != 'true'
        run: npm run generate:api
      - name: Lint
        run: npm run lint
      - name: Test
        run: npm test
      - name: Build for PR Preview
        run: npm run build
        env:
          # PR previews run in demo-only mode (no real authentication)
          VITE_DEMO_MODE_ONLY: 'true'
          # Set base path for PR preview - uses pr-{number} subdirectory
          VITE_BASE_PATH: /${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/
          # OJP API key for Swiss public transport travel times
          VITE_OJP_API_KEY: ${{ secrets.VITE_OJP_API_KEY }}
      - name: Add .nojekyll for GitHub Pages
        run: touch dist/.nojekyll
      # Build OCR POC
      - name: Install OCR POC dependencies
        run: npm ci
        working-directory: ocr-poc
      - name: Lint OCR POC
        run: npm run lint
        working-directory: ocr-poc
      - name: Build OCR POC
        run: npm run build
        working-directory: ocr-poc
        env:
          VITE_BASE_PATH: /${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/ocr-poc/
      # Build Help Site
      - name: Install Help Site dependencies
        run: npm ci
        working-directory: help-site
      - name: Build Help Site
        run: npm run build
        working-directory: help-site
      # Download existing gh-pages content to preserve main site and other PR previews
      - name: Download existing gh-pages content
        run: |
          if git ls-remote --exit-code --heads origin gh-pages; then
            echo "Cloning existing gh-pages branch..."
            git clone --depth 1 --branch gh-pages \
              https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git \
              ${{ github.workspace }}/gh-pages-current
          else
            echo "gh-pages branch does not exist yet, starting fresh"
          fi
        working-directory: ${{ github.workspace }}
      - name: Prepare deployment with PR preview
        run: |
          mkdir -p ${{ github.workspace }}/deploy
          # Copy existing content (if any) preserving main site
          if [ -d "${{ github.workspace }}/gh-pages-current" ]; then
            rsync -a --exclude='.git' ${{ github.workspace }}/gh-pages-current/ ${{ github.workspace }}/deploy/
          fi
          # Add/update this PR's preview (web-app)
          mkdir -p ${{ github.workspace }}/deploy/pr-${{ github.event.pull_request.number }}
          cp -r dist/* ${{ github.workspace }}/deploy/pr-${{ github.event.pull_request.number }}/
          # Add/update OCR POC preview
          mkdir -p ${{ github.workspace }}/deploy/pr-${{ github.event.pull_request.number }}/ocr-poc
          cp -r ${{ github.workspace }}/ocr-poc/dist/* ${{ github.workspace }}/deploy/pr-${{ github.event.pull_request.number }}/ocr-poc/
          # Add/update Help Site preview
          mkdir -p ${{ github.workspace }}/deploy/pr-${{ github.event.pull_request.number }}/help
          cp -r ${{ github.workspace }}/help-site/dist/* ${{ github.workspace }}/deploy/pr-${{ github.event.pull_request.number }}/help/
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ github.workspace }}/deploy
          keep_files: false
          enable_jekyll: false
      - name: Comment PR with preview link
        uses: actions/github-script@v8
        with:
          script: |
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/`;
            const ocrPocUrl = `${previewUrl}ocr-poc/`;
            const helpUrl = `${previewUrl}help/`;
            const body = `## ðŸš€ PR Preview Deployed!\n\n` +
              `Your preview is ready at: ${previewUrl}\n\n` +
              `**OCR POC:** ${ocrPocUrl}\n\n` +
              `**Help Site:** ${helpUrl}\n\n` +
              `> This preview will be updated on each push to this PR.\n\n` +
              `**Demo Mode Only:** This preview runs in demo mode with sample data. Real authentication is disabled for security.`;

            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c => c.body.includes('PR Preview Deployed'));

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
