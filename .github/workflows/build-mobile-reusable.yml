name: Build Mobile App (Reusable)

on:
  workflow_call:
    inputs:
      platform:
        description: 'Platform to build (android or ios)'
        required: true
        type: string
      ref:
        description: 'Git ref to checkout'
        required: true
        type: string
      version:
        description: 'Version label for artifact filename'
        required: true
        type: string
      upload_to_release:
        description: 'Upload artifact to GitHub release'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag to upload to (required if upload_to_release is true)'
        required: false
        type: string
        default: ''
    secrets:
      EXPO_TOKEN:
        required: true
      RELEASE_TOKEN:
        required: false

jobs:
  build:
    runs-on: ${{ inputs.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: packages/mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: packages/mobile

      - name: Generate API types
        run: npm run generate:api
        working-directory: .

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          eas-cache: false

      - name: Build Android APK
        if: inputs.platform == 'android'
        run: eas build --platform android --profile production --non-interactive --local --output ./volleykit-${{ inputs.version }}.apk

      - name: Build iOS IPA
        if: inputs.platform == 'ios'
        run: eas build --platform ios --profile development --non-interactive --local --output ./volleykit-${{ inputs.version }}.ipa

      - name: Upload APK artifact
        if: inputs.platform == 'android'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ inputs.version }}
          path: packages/mobile/volleykit-${{ inputs.version }}.apk
          retention-days: 30

      - name: Upload IPA artifact
        if: inputs.platform == 'ios'
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ inputs.version }}
          path: packages/mobile/volleykit-${{ inputs.version }}.ipa
          retention-days: 30

      - name: Upload to Release
        if: inputs.upload_to_release && inputs.release_tag != ''
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          if [ "${{ inputs.platform }}" = "android" ]; then
            gh release upload "${{ inputs.release_tag }}" \
              "./volleykit-${{ inputs.version }}.apk" \
              --clobber
          else
            gh release upload "${{ inputs.release_tag }}" \
              "./volleykit-${{ inputs.version }}.ipa" \
              --clobber
          fi

      - name: Summary
        run: |
          if [ "${{ inputs.platform }}" = "android" ]; then
            echo "## Android Build Complete" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Ref | \`${{ inputs.ref }}\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Artifact | \`volleykit-${{ inputs.version }}.apk\` |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## iOS Build Complete" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Ref | \`${{ inputs.ref }}\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Profile | \`development\` (dev client, internal distribution) |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Artifact | \`volleykit-${{ inputs.version }}.ipa\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> Register devices at [expo.dev](https://expo.dev) to install this IPA" >> "$GITHUB_STEP_SUMMARY"
          fi
