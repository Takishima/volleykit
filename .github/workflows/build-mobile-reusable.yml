name: Build Mobile App (Reusable)

on:
  workflow_call:
    inputs:
      platform:
        description: 'Platform to build (android or ios)'
        required: true
        type: string
      ref:
        description: 'Git ref to checkout'
        required: true
        type: string
      version:
        description: 'Version label for artifact filename'
        required: true
        type: string
      upload_to_release:
        description: 'Upload artifact to GitHub release'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag to upload to (required if upload_to_release is true)'
        required: false
        type: string
        default: ''
    secrets:
      EXPO_TOKEN:
        required: true
      RELEASE_TOKEN:
        required: false
      IOS_DIST_CERT_BASE64:
        required: false
        description: 'Base64-encoded iOS distribution certificate (.p12)'
      IOS_DIST_CERT_PASSWORD:
        required: false
        description: 'Password for iOS distribution certificate'
      IOS_PROVISIONING_PROFILE_BASE64:
        required: false
        description: 'Base64-encoded iOS provisioning profile (.mobileprovision)'

jobs:
  build-android:
    if: inputs.platform == 'android'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: packages/mobile

      - name: Generate API types
        run: npm run generate:api
        working-directory: .

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android APK
        run: eas build --platform android --profile production --non-interactive --local --output ./volleykit-${{ inputs.version }}.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ inputs.version }}
          path: packages/mobile/volleykit-${{ inputs.version }}.apk
          retention-days: 30

      - name: Upload APK to Release
        if: inputs.upload_to_release && inputs.release_tag != ''
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          gh release upload "${{ inputs.release_tag }}" \
            "./volleykit-${{ inputs.version }}.apk" \
            --clobber

      - name: Summary
        run: |
          echo "## Android Build Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ref | \`${{ inputs.ref }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | \`volleykit-${{ inputs.version }}.apk\` |" >> "$GITHUB_STEP_SUMMARY"

  build-ios:
    if: inputs.platform == 'ios'
    runs-on: macos-latest
    defaults:
      run:
        working-directory: packages/mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: packages/mobile

      - name: Generate API types
        run: npm run generate:api
        working-directory: .

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Setup iOS credentials
        env:
          IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
          IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p certs
          echo "$IOS_DIST_CERT_BASE64" | base64 --decode > certs/distribution.p12
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > certs/profile.mobileprovision
          cat > credentials.json << EOF
          {
            "ios": {
              "ch.volleyball.volleykit": {
                "distributionCertificate": {
                  "path": "./certs/distribution.p12",
                  "password": "$IOS_DIST_CERT_PASSWORD"
                },
                "provisioningProfilePath": "./certs/profile.mobileprovision"
              }
            }
          }
          EOF

      - name: Build iOS
        run: eas build --platform ios --profile production --non-interactive --local --output ./volleykit-${{ inputs.version }}.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ inputs.version }}
          path: packages/mobile/volleykit-${{ inputs.version }}.ipa
          retention-days: 30

      - name: Upload IPA to Release
        if: inputs.upload_to_release && inputs.release_tag != ''
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          gh release upload "${{ inputs.release_tag }}" \
            "./volleykit-${{ inputs.version }}.ipa" \
            --clobber

      - name: Summary
        run: |
          echo "## iOS Build Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ref | \`${{ inputs.ref }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | \`volleykit-${{ inputs.version }}.ipa\` |" >> "$GITHUB_STEP_SUMMARY"
