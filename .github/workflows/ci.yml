name: CI
on:
  push:
    branches: [main]
    paths:
      - 'web-app/**'
      - 'packages/shared/**'
      - 'docs/api/volleymanager-openapi.yaml'
      - '.github/workflows/ci.yml'
      - '.github/actions/**'
  pull_request:
    paths:
      - 'web-app/**'
      - 'packages/shared/**'
      - 'docs/api/volleymanager-openapi.yaml'
      - '.changeset/**'
      - '.github/workflows/ci.yml'
      - '.github/actions/**'

# =============================================================================
# CI Pipeline Architecture
# =============================================================================
#
# Job Dependency Graph:
#
#   setup ─────┬──────────────────────────────────────┐
#   (API types)│                                      │
#              ├──> lint ──────┐                      │
#              ├──> knip       │                      │
#              ├──> test       │                      │
#              └──> build ─────┼──> bundle-size       │
#                              ├──> e2e (per browser) │
#                              └──> lighthouse        │
#                                                     │
#   audit (independent) ──────────────────────────────┘
#   changeset (PR only, independent) ─────────────────┘
#
# Key Design Decisions:
# - setup job generates API types ONCE, shared via artifact to avoid 4x generation
# - audit runs independently (doesn't need API types)
# - build artifact is shared by bundle-size, e2e, and lighthouse
# - Tool caches (ESLint, Vitest, Vite) keyed by config, not source files for better reuse
# - PRs run chromium only; main branch runs chromium + firefox + webkit
# - E2E uses pre-built Playwright Docker image (no browser install overhead)
#
# =============================================================================

jobs:
  # Setup job - generates API types once, shared by all downstream jobs
  # This is the CRITICAL PATH for lint, knip, test, and build jobs
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      api-cache-key: ${{ steps.api-cache-key.outputs.key }}
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Generate API cache key
        id: api-cache-key
        run: echo "key=api-types-${{ hashFiles('docs/api/volleymanager-openapi.yaml', 'web-app/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Cache generated API types
        id: api-cache
        uses: actions/cache@v5
        with:
          path: web-app/src/api/schema.ts
          key: ${{ steps.api-cache-key.outputs.key }}

      - name: Generate API types
        if: steps.api-cache.outputs.cache-hit != 'true'
        run: npm run generate:api

      # Upload API types as artifact for downstream jobs
      - name: Upload API types
        uses: actions/upload-artifact@v5
        with:
          name: api-types
          path: web-app/src/api/schema.ts
          retention-days: 1

  # Security audit - runs independently (doesn't need API types)
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Audit dependencies
        run: npm audit --audit-level=high --omit=dev

  # Lint check - needs API types from setup
  lint:
    name: Lint
    needs: setup
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Download API types
        uses: actions/download-artifact@v7
        with:
          name: api-types
          path: web-app/src/api

      # Cache ESLint results (ESLint handles per-file invalidation internally)
      # Key based on ESLint config, TypeScript config, and plugins
      - name: Cache ESLint
        uses: actions/cache@v5
        with:
          path: web-app/.eslintcache
          key: eslint-${{ runner.os }}-${{ hashFiles('web-app/eslint.config.js', 'web-app/tsconfig.json', 'web-app/package-lock.json') }}
          restore-keys: |
            eslint-${{ runner.os }}-

      - name: Lint
        run: npm run lint -- --cache --cache-location .eslintcache

  # Dead code detection - needs API types from setup
  knip:
    name: Dead Code Check
    needs: setup
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Download API types
        uses: actions/download-artifact@v7
        with:
          name: api-types
          path: web-app/src/api

      - name: Check for dead code
        run: npm run knip

  # Unit tests - needs API types from setup
  # PRs: only run tests affected by changed files (--changed)
  # main: run all tests for full coverage validation
  test:
    name: Test
    needs: setup
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          # Full history needed for --changed to compare against base branch
          fetch-depth: 0

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Download API types
        uses: actions/download-artifact@v7
        with:
          name: api-types
          path: web-app/src/api

      # Cache Vite/Vitest transform cache (Vitest stores cache in .vite/vitest)
      # Key based on tooling config - source file changes don't invalidate transforms
      - name: Cache Vite
        uses: actions/cache@v5
        with:
          path: web-app/node_modules/.vite
          key: vite-${{ runner.os }}-${{ hashFiles('web-app/package-lock.json', 'web-app/vite.config.ts', 'web-app/tsconfig.json') }}
          restore-keys: |
            vite-${{ runner.os }}-

      - name: Run tests
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRs: only run tests affected by changes since base branch
            npm test -- --changed origin/${{ github.base_ref }}
          else
            # main branch: run all tests
            npm test
          fi

  # Build once - artifact shared by bundle-size, e2e, and lighthouse
  build:
    name: Build
    needs: setup
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Download API types
        uses: actions/download-artifact@v7
        with:
          name: api-types
          path: web-app/src/api

      # Cache Vite pre-bundled dependencies (shared key with test job)
      # Key based on dependencies and config - source changes don't affect dep pre-bundling
      - name: Cache Vite
        uses: actions/cache@v5
        with:
          path: web-app/node_modules/.vite
          key: vite-${{ runner.os }}-${{ hashFiles('web-app/package-lock.json', 'web-app/vite.config.ts', 'web-app/tsconfig.json') }}
          restore-keys: |
            vite-${{ runner.os }}-

      - name: Build
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v5
        with:
          name: web-app-dist
          path: web-app/dist
          retention-days: 1

  # Bundle size check - lightweight job, only needs build artifact
  bundle-size:
    name: Bundle Size
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: web-app-dist
          path: web-app/dist

      - name: Check bundle size
        run: npm run size

  # E2E tests - per browser, uses build artifact
  # PRs: chromium only (fast feedback)
  # main: chromium + firefox + webkit (full coverage)
  # Uses pre-built Playwright Docker image (browsers pre-installed)
  e2e:
    name: E2E (${{ matrix.browser }})
    needs: build
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-noble
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        # PRs: chromium only; main: all browsers
        browser: ${{ github.event_name == 'pull_request' && fromJson('["chromium"]') || fromJson('["chromium", "firefox", "webkit"]') }}
    defaults:
      run:
        working-directory: web-app
    # Firefox requires HOME to be owned by current user in containers
    env:
      HOME: /root
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: web-app-dist
          path: web-app/dist

      - name: Run E2E tests
        run: npx playwright test --project=${{ matrix.browser }} --retries=2

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-${{ matrix.browser }}
          path: web-app/playwright-report/
          retention-days: 7

  # Lighthouse performance audit - uses build artifact
  lighthouse:
    name: Lighthouse
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js with dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          working-directory: web-app

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: web-app-dist
          path: web-app/dist

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          uploadArtifacts: true
          configPath: ./web-app/lighthouserc.json

  # Changeset check - ensures PRs include changelog entries
  # Only runs on PRs, reports missing changesets (informational)
  changeset:
    name: Changeset
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install changeset CLI
        run: npm install -g @changesets/cli

      - name: Check for changesets
        id: changeset_check
        run: |
          # Count changeset files (excluding config.json and README.md)
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" 2>/dev/null | wc -l)

          if [ "$CHANGESET_COUNT" -eq 0 ]; then
            echo "has_changeset=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No changeset found. If this PR includes user-facing changes, please run 'npx changeset' to add a changelog entry."
          else
            echo "has_changeset=true" >> "$GITHUB_OUTPUT"
            echo "Found $CHANGESET_COUNT changeset(s)"
          fi

      - name: Summary
        run: |
          if [ "${{ steps.changeset_check.outputs.has_changeset }}" = "true" ]; then
            echo "## Changeset Found" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "This PR includes changelog entries." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## No Changeset" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "This PR does not include a changeset." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "If this PR includes user-facing changes (features, fixes), please add a changeset:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```bash' >> "$GITHUB_STEP_SUMMARY"
            echo 'npx changeset' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "If this PR is docs-only or internal, no changeset is needed." >> "$GITHUB_STEP_SUMMARY"
          fi
