name = "volleykit-proxy"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Worker configuration
# Free tier: 100,000 requests/day, 10ms CPU time per request
# See: https://developers.cloudflare.com/workers/platform/limits/

# =============================================================================
# RATE LIMITING CONFIGURATION (Required - configure in Cloudflare Dashboard)
# =============================================================================
# This worker MUST be protected by Cloudflare Rate Limiting rules.
# In-memory rate limiting in Workers doesn't work reliably across instances.
#
# Configure via: Cloudflare Dashboard > Security > WAF > Rate limiting rules
#
# Rule 1: API Rate Limit
#   - Matching URL: volleykit-proxy.*.workers.dev/*
#   - Requests: 100 per minute
#   - Action: Block for 1 minute
#   - Characteristics: IP address
#
# Rule 2: Login Rate Limit (stricter)
#   - Matching URL: volleykit-proxy.*.workers.dev/login* OR /sportmanager.security/*
#   - Requests: 10 per minute
#   - Action: Block for 5 minutes
#   - Characteristics: IP address
#
# For custom domains, update the matching URLs accordingly.
# See: https://developers.cloudflare.com/waf/rate-limiting-rules/
# =============================================================================

# =============================================================================
# ENVIRONMENT VARIABLES (MUST CONFIGURE FOR YOUR DEPLOYMENT)
# =============================================================================
# IMPORTANT FOR FORKERS: You MUST update ALLOWED_ORIGINS to your own domain!
#
# ALLOWED_ORIGINS: Comma-separated list of allowed origins for CORS
#   - Change this to YOUR GitHub Pages URL or custom domain
#   - Format: "https://yourusername.github.io" (no trailing slash)
#   - Multiple origins: "https://domain1.com,https://domain2.com"
#   - DO NOT include localhost - use Vite dev proxy instead
#
# TARGET_HOST: The backend API server to proxy requests to
#   - Default: https://volleymanager.volleyball.ch (Swiss volleyball)
#   - Only change if you're proxying to a different backend
# =============================================================================
[vars]
ALLOWED_ORIGINS = "https://takishima.github.io"
TARGET_HOST = "https://volleymanager.volleyball.ch"

# =============================================================================
# SECRETS (Configure via Cloudflare Dashboard or wrangler secret)
# =============================================================================
# MISTRAL_API_KEY: API key for Mistral OCR service
#   - Required for the /ocr endpoint to function
#   - Get a key from: https://console.mistral.ai/
#   - Set via: npx wrangler secret put MISTRAL_API_KEY
#   - Or configure in Cloudflare Dashboard > Workers > volleykit-proxy > Settings > Variables
#
# Note: Secrets are not stored in this file for security reasons.
# =============================================================================

# =============================================================================
# RATE LIMITING BINDING (In-Worker Rate Limiting)
# =============================================================================
# Uses Cloudflare's Rate Limiting binding for programmatic rate limiting.
# This provides per-IP rate limiting directly in the worker code.
#
# Configuration:
#   - limit: 100 requests
#   - period: 60 seconds (1 minute)
#
# The worker code checks this binding and returns 429 when limit is exceeded.
# See: https://developers.cloudflare.com/workers/runtime-apis/bindings/rate-limit/
# =============================================================================
[[ratelimits]]
name = "RATE_LIMITER"
namespace_id = "1001"
simple = { limit = 100, period = 60 }

# =============================================================================
# AUTH LOCKOUT KV STORAGE
# =============================================================================
# Stores failed login attempts per IP for brute-force protection.
# This is tamper-proof as it's server-side storage.
#
# To create the KV namespace:
#   npx wrangler kv namespace create AUTH_LOCKOUT
#
# Then update the id below with the returned namespace ID.
#
# For preview/dev environments:
#   npx wrangler kv namespace create AUTH_LOCKOUT --preview
# =============================================================================
[[kv_namespaces]]
binding = "AUTH_LOCKOUT"
id = "53a59c378b3a46f58dbde0b4128e4840"
preview_id = "3bd4bb21113740ba950ed53f3dbdd1d8"

# Observability (for debugging in Cloudflare dashboard)
[observability]
enabled = true
