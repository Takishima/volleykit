import{bb as C,_ as b,l as c,d as O}from"./index-DgvpdgLj.js";import{a as o,j as x}from"./chunk-state-1lfzh_F6.js";import"./chunk-router-BHRPxDXG.js";import"./chunk-validation-Cdg1t4SS.js";const L=O,P="volleykit-worker-version",T=5e3;function $({children:v}){const[E,m]=o.useState(!1),[k,f]=o.useState(!1),[g,d]=o.useState(!1),[l,h]=o.useState(null),[y,w]=o.useState(null),[r,W]=o.useState(null),u=o.useRef(null),p=o.useRef(void 0),S=o.useRef(null),R=o.useRef(!1);o.useEffect(()=>{const t=()=>{document.visibilityState==="visible"&&u.current&&u.current.update().catch(()=>{})},n=e=>{e.persisted&&u.current&&u.current.update().catch(()=>{})};return document.addEventListener("visibilitychange",t),window.addEventListener("pageshow",n),()=>{document.removeEventListener("visibilitychange",t),window.removeEventListener("pageshow",n)}},[]),o.useEffect(()=>{let t=!1;async function n(){try{const{registerSW:e}=await b(async()=>{const{registerSW:a}=await Promise.resolve().then(()=>A);return{registerSW:a}},void 0),s=e({immediate:!0,onRegisteredSW(a,i){t||!i||(u.current=i,p.current=setInterval(()=>{i.update()},L))},onOfflineReady(){t||m(!0)},onNeedRefresh(){t||f(!0)},onRegisterError(a){if(c.error("Service worker registration error:",a),!t){const i=a instanceof Error?a:new Error("Service worker registration failed");W(i)}}});t||(S.current=s)}catch(e){if(c.error("Failed to register service worker:",e),!t){const s=e instanceof Error?e:new Error("Failed to register service worker");W(s)}}}return n(),()=>{t=!0,p.current&&(clearInterval(p.current),p.current=void 0)}},[]);const I={offlineReady:E,needRefresh:k,isChecking:g,lastChecked:l,checkError:y,registrationError:r,checkForUpdate:async()=>{if(!(!u.current||R.current)){R.current=!0,d(!0),w(null);try{await u.current.update(),h(new Date)}catch(t){const n=t instanceof Error?t:new Error("Failed to check for updates");c.error("Failed to check for updates:",t),w(n)}finally{R.current=!1,d(!1)}}},updateApp:async()=>{let t=!1;const n="https://volleykit-proxy.ngn-damien.workers.dev";try{const e=localStorage.getItem(P),s=new AbortController,a=setTimeout(()=>s.abort(),T),i=await fetch(`${n}/version?t=${Date.now()}`,{signal:s.signal});if(clearTimeout(a),i.ok){const _=(await i.json()).workerGitHash;localStorage.setItem(P,_),e&&e!==_&&(c.info("Worker version changed, will clear session:",{from:e,to:_}),t=!0)}}catch(e){localStorage.getItem("volleykit-auth")!==null&&(c.warn("Could not fetch worker version, clearing session for safety:",e),t=!0)}if(t)try{localStorage.removeItem("volleykit-session-token"),localStorage.removeItem("volleykit-auth")}catch{}else c.info("Web app only update, preserving session");if(S.current)await S.current(!0);else{c.warn("Service worker not ready, using fallback reload mechanism");try{const e=await caches?.keys()||[];await Promise.all(e.map(s=>caches.delete(s)))}catch(e){c.warn("Failed to clear caches during fallback update:",e)}try{const e=new URL(window.location.href);e.searchParams.set("_pwa_update",Date.now().toString()),window.location.replace(e.href)}catch{window.location.reload()}}},dismissPrompt:()=>{m(!1),f(!1)}};return x.jsx(C.Provider,{value:I,children:v})}function U(v={}){const{immediate:E=!1,onNeedRefresh:m,onOfflineReady:k,onRegistered:f,onRegisteredSW:g,onRegisterError:d}=v;let l,h;const y=async(r=!0)=>{await h};async function w(){if("serviceWorker"in navigator){if(l=await b(async()=>{const{Workbox:r}=await import("./chunk-workbox-window.prod.es5-BIl4cyR9.js");return{Workbox:r}},[]).then(({Workbox:r})=>new r("/volleykit/sw.js",{scope:"/volleykit/",type:"classic"})).catch(r=>{d?.(r)}),!l)return;l.addEventListener("activated",r=>{(r.isUpdate||r.isExternal)&&window.location.reload()}),l.addEventListener("installed",r=>{r.isUpdate||k?.()}),l.register({immediate:E}).then(r=>{g?g("/volleykit/sw.js",r):f?.(r)}).catch(r=>{d?.(r)})}}return h=w(),y}const A=Object.freeze(Object.defineProperty({__proto__:null,registerSW:U},Symbol.toStringTag,{value:"Module"}));export{$ as default};
