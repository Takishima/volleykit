import{u as v,a as n,b as U}from"./chunk-state-CZJejFfH.js";import{e as T,o as F,p as Q,q as E,A as G,r as k,t as P,v as D,w as M,x as B,D as x,y as L}from"./index-CIake4Zx.js";const g=k(),R=[];function W(e){return e.convocationCompensation?{__identity:e.__identity,refereeGame:e.refereeGame,convocationCompensation:e.convocationCompensation,refereeConvocationStatus:e.refereeConvocationStatus,compensationDate:e.refereeGame?.game?.startingDateTime,refereePosition:e.refereePosition,_permissions:e._permissions}:null}function Y(e,a){const c=e.getQueriesData({queryKey:E.assignments.all}),r=[],u=Date.now();for(const[p,l]of c){if(p[3]!==a)continue;const s=e.getQueryState(p);!s?.dataUpdatedAt||u-s.dataUpdatedAt>G||l?.items&&r.push(...l.items)}if(r.length===0)return null;const d=new Set,f=r.filter(p=>d.has(p.__identity)?!1:(d.add(p.__identity),!0));return g.debug("Found fresh assignments in cache:",{count:f.length}),f}const q={ASSIGNMENT_NOT_FOUND:"compensations.assignmentNotFoundInCache",COMPENSATION_NOT_FOUND:"compensations.compensationNotFound",COMPENSATION_MISSING_ID:"compensations.compensationMissingId"};function X(e){const a=v(),c=T(s=>s.dataSource),r=c==="demo",u=T(s=>s.activeOccupationId),d=F(s=>s.activeAssociationCode),f=Q(c),p=r?d:u,l=n.useMemo(()=>{const s=Y(a,p);if(!s)return null;const C=s.map(W).filter(S=>S!==null);return g.debug("Derived compensations from assignments cache:",{count:C.length}),{items:C,totalItemsCount:C.length}},[a,p]),A={offset:0,limit:x,propertyFilters:[],propertyOrderings:[{propertyName:"refereeGame.game.startingDateTime",descending:!0,isSetByUser:!0}]};return U({queryKey:E.compensations.list(A,p),queryFn:()=>l?(g.debug("Using cached assignments data for compensations (skipping API call)"),Promise.resolve(l)):f.searchCompensations(A),select:s=>{const C=s.items??R;return e===void 0?C:C.filter(S=>S.convocationCompensation?.paymentDone===e)},staleTime:L})}function $(){const e=v(),a=T(o=>o.dataSource),c=P(),{refresh:r}=D(),u=Q(a),[d,f]=n.useState(!1),[p,l]=n.useState(!1),[A,s]=n.useState(!1),[C,S]=n.useState(null),[b,w]=n.useState(!1),_=n.useCallback(()=>{f(!1),l(!1),s(!1),S(null),w(!1)},[]),y=n.useCallback(async({compensationId:o,data:m})=>{_(),f(!0);try{if(c)g.debug("Updating compensation (online):",{compensationId:o,data:m,dataSource:a}),await u.updateCompensation(o,m),await e.invalidateQueries({queryKey:E.compensations.lists()}),await e.invalidateQueries({queryKey:E.assignments.lists()}),l(!0),w(!1);else{if(g.debug("Queueing compensation update (offline):",{compensationId:o,data:m}),!await M("updateCompensation",{compensationId:o,data:m}))throw new Error("Failed to queue action - IndexedDB unavailable");await r(),l(!0),w(!0)}}catch(t){const i=t instanceof Error?t:new Error(String(t));throw g.error("Failed to update compensation:",i),s(!0),S(i),i}finally{f(!1)}},[c,a,u,e,r,_]);return{mutate:n.useCallback((o,m)=>{y(o).then(()=>{m?.onSuccess?.()}).catch(t=>{m?.onError?.(t)})},[y]),mutateAsync:y,isPending:d,isSuccess:p,isError:A,error:C,reset:_,wasQueued:b}}function ee(){const e=v(),a=T(o=>o.dataSource),c=P(),{refresh:r}=D(),u=Q(a),[d,f]=n.useState(!1),[p,l]=n.useState(!1),[A,s]=n.useState(!1),[C,S]=n.useState(null),[b,w]=n.useState(!1),_=n.useCallback(()=>{f(!1),l(!1),s(!1),S(null),w(!1)},[]),y=n.useCallback(async({compensationIds:o,data:m})=>{_(),f(!0);try{if(c){g.debug("Batch updating compensations (online):",{count:o.length,data:m,dataSource:a});let t=0,i=0;for(const h of o)try{await u.updateCompensation(h,m),t++}catch(N){g.error("Failed to update compensation in batch:",{compensationId:h,error:N}),i++}return await e.invalidateQueries({queryKey:E.compensations.lists()}),await e.invalidateQueries({queryKey:E.assignments.lists()}),l(!0),w(!1),{successCount:t,failedCount:i,totalCount:o.length}}else{if(g.debug("Queueing batch compensation update (offline):",{count:o.length,data:m}),!await M("batchUpdateCompensations",{compensationIds:o,data:m}))throw new Error("Failed to queue action - IndexedDB unavailable");return await r(),l(!0),w(!0),{successCount:o.length,failedCount:0,totalCount:o.length}}}catch(t){const i=t instanceof Error?t:new Error(String(t));throw g.error("Failed to batch update compensations:",i),s(!0),S(i),i}finally{f(!1)}},[c,a,u,e,r,_]);return{mutate:n.useCallback((o,m)=>{y(o).then(t=>{m?.onSuccess?.(t)}).catch(t=>{m?.onError?.(t)})},[y]),mutateAsync:y,isPending:d,isSuccess:p,isError:A,error:C,reset:_,wasQueued:b}}function Z(e,a){const c=a.getQueriesData({queryKey:E.assignments.all});for(const[,r]of c){const u=r?.items?.find(d=>d.__identity===e);if(u)return u}return null}function j(e,a){const c=a.getQueriesData({queryKey:E.compensations.all});for(const[,r]of c){const u=r?.items?.find(d=>d.refereeGame?.game?.number===e);if(u)return u}return null}async function z(e,a){return g.debug("Fetching compensations from API:",{gameNumber:e}),(await a.searchCompensations({limit:B})).items.find(r=>r.refereeGame?.game?.number===e)||null}function te(){const e=v(),a=T(t=>t.dataSource),c=a==="demo",r=P(),{refresh:u}=D(),d=F(t=>t.updateAssignmentCompensation),f=Q(a),[p,l]=n.useState(!1),[A,s]=n.useState(!1),[C,S]=n.useState(!1),[b,w]=n.useState(null),[_,y]=n.useState(!1),I=n.useCallback(()=>{l(!1),s(!1),S(!1),w(null),y(!1)},[]),o=n.useCallback(async({assignmentId:t,data:i})=>{I(),l(!0);try{if(c){d(t,i),s(!0),y(!1);return}const h=Z(t,e);if(!h?.refereeGame?.game?.number)throw new Error(q.ASSIGNMENT_NOT_FOUND);const N=h.refereeGame.game.number;let O=j(N,e)?.convocationCompensation?.__identity;if(r){if(O||(g.debug("Compensation not in cache, fetching from API:",{gameNumber:N}),O=(await z(N,f))?.convocationCompensation?.__identity),!O)throw new Error(q.COMPENSATION_NOT_FOUND);g.debug("Updating compensation via API (online):",{assignmentId:t,compensationId:O,data:i}),await f.updateCompensation(O,i),await e.invalidateQueries({queryKey:E.assignments.detail(t)}),await e.invalidateQueries({queryKey:E.assignments.lists()}),await e.invalidateQueries({queryKey:E.compensations.lists()}),s(!0),y(!1)}else{if(!O)throw new Error(q.COMPENSATION_NOT_FOUND);if(g.debug("Queueing compensation update (offline):",{assignmentId:t,compensationId:O,data:i}),!await M("updateCompensation",{compensationId:O,data:i}))throw new Error("Failed to queue action - IndexedDB unavailable");await u(),s(!0),y(!0)}}catch(h){const N=h instanceof Error?h:new Error(String(h));throw g.error("Failed to update assignment compensation:",N),S(!0),w(N),N}finally{l(!1)}},[c,r,e,f,d,u,I]);return{mutate:n.useCallback((t,i)=>{o(t).then(()=>{i?.onSuccess?.()}).catch(h=>{i?.onError?.(h)})},[o]),mutateAsync:o,isPending:p,isSuccess:A,isError:C,error:b,reset:I,wasQueued:_}}export{q as C,$ as a,te as b,ee as c,X as u};
