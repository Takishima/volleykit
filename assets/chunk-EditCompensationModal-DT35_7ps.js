import{a as p,u as Z,j as o}from"./chunk-state-CZJejFfH.js";import{u as ee,e as te,o as ae,G as T,l as f,J as v,T as ne,M as oe,a as se,U as re,B as L,V as ie,b as ce,q as J,W as de,p as U,x as le}from"./index-DFv-1OfD.js";import{d as me,e as ue,f as pe}from"./chunk-ModalErrorBoundary-0IzKC7SI.js";import{a as fe,b as ge,c as xe,C as V}from"./chunk-useCompensations-RKx0bWci.js";import{i as he}from"./chunk-PdfLanguageModal-DddJbe0c.js";import"./chunk-router-CqUdIx6-.js";import"./chunk-validation-Cdg1t4SS.js";function be(a,d){const n=d.getQueriesData({queryKey:J.compensations.all});for(const[,t]of n){const e=t?.items?.find(l=>String(l.refereeGame?.game?.number)===String(a));if(e)return e}return null}function ye(a,d,n){if(!d||!a)return[];const t=n.getQueriesData({queryKey:J.compensations.all}),e=[],l=new Set;for(const[,g]of t)if(g?.items)for(const s of g.items){const i=s.convocationCompensation?.__identity,u=s.refereeGame?.game?.hall?.__identity;!i||i===a||l.has(i)||u===d&&he(s)&&(l.add(i),e.push(s))}return e}function Ce(a){const d=a.convocationCompensation;if(!d)return null;const n=d.distanceInMetres,t=n!==void 0&&n>0?T(n):"",l=d.hasFlexibleTravelExpenses!==!1;return{distanceKm:t,isDistanceEditable:l,compensationId:d.__identity}}function Ee(a,d,n){let t=!1;return(async()=>{const l=U(d);try{const g=await l.getCompensationDetails(a);if(t)return;const s=g.convocationCompensation?.correctionReason;s&&n.setReason(s)}catch(g){t||f.debug("[EditCompensationModal] Could not fetch correctionReason:",g)}})(),()=>{t=!0}}function ke(a,d,n,t,e){let l=!1;return(async()=>{t.setIsLoading(!0),t.setFetchError(null);const s=U(d);try{let i=be(a,n)?.convocationCompensation?.__identity;if(!i){const E=await s.searchCompensations({limit:le});if(l)return;i=E.items.find(k=>String(k.refereeGame?.game?.number)===String(a))?.convocationCompensation?.__identity}if(!i){f.debug("[EditCompensationModal] No compensation found for game number:",a);return}const u=await s.getCompensationDetails(i);if(l)return;const x=u.convocationCompensation?.distanceInMetres;x!==void 0&&x>0&&t.setKilometers(T(x));const h=u.convocationCompensation?.correctionReason;h&&t.setReason(h);const C=u.convocationCompensation?.hasFlexibleTravelExpenses;t.setIsDistanceEditable(C!==!1),f.debug("[EditCompensationModal] Loaded compensation details for assignment:",u)}catch(i){if(l)return;f.error("[EditCompensationModal] Failed to fetch compensation details for assignment:",i);const u=i instanceof Error?i.message:"",h=Object.values(V).includes(u);t.setFetchError(h?e(u):u||e("assignments.failedToLoadData"))}finally{l||t.setIsLoading(!1)}})(),()=>{l=!0}}function ve(a,d,n,t){let e=!1;return(async()=>{n.setIsLoading(!0),n.setFetchError(null);const g=U(d);try{const s=await g.getCompensationDetails(a);if(e)return;const i=s.convocationCompensation?.distanceInMetres;i!==void 0&&i>0&&n.setKilometers(T(i));const u=s.convocationCompensation?.correctionReason;u&&n.setReason(u);const x=s.convocationCompensation?.hasFlexibleTravelExpenses;n.setIsDistanceEditable(x!==!1),f.debug("[EditCompensationModal] Loaded compensation details:",s)}catch(s){if(e)return;f.error("[EditCompensationModal] Failed to fetch compensation details:",s);const i=s instanceof Error?s.message:"",x=Object.values(V).includes(i);n.setFetchError(x?t(i):i||t("assignments.failedToLoadData"))}finally{e||n.setIsLoading(!1)}})(),()=>{e=!0}}function Me({assignment:a,compensation:d,isOpen:n,onClose:t}){const{t:e,tInterpolate:l}=ee(),g=Z(),s=te(c=>c.dataSource),i=ae(c=>c.getAssignmentCompensation),u=fe(),x=ge(),h=xe(),[C,E]=p.useState(""),[S,k]=p.useState(""),[N,_]=p.useState({}),[A,W]=p.useState(!1),[P,q]=p.useState(null),[I,j]=p.useState(!0),[D,B]=p.useState(!1),b=!!a&&!d,F=u.isPending||x.isPending||h.isPending,y=d?.convocationCompensation?.__identity||a?.convocationCompensation?.__identity,G=d?.refereeGame?.game?.hall?.__identity,H=d?.refereeGame?.game?.hall?.name,M=p.useMemo(()=>b||!n?[]:ye(y,G,g),[b,n,y,G,g]);p.useEffect(()=>{if(!n)return;const c={setKilometers:E,setReason:k,setIsDistanceEditable:j,setIsLoading:W,setFetchError:q};if(b&&s==="demo"&&a){const r=i(a.__identity),m=a.convocationCompensation?.hasFlexibleTravelExpenses;queueMicrotask(()=>{r&&(r.distanceInMetres!==void 0&&r.distanceInMetres>0&&E(T(r.distanceInMetres)),r.correctionReason&&k(r.correctionReason),f.debug("[EditCompensationModal] Loaded from demo store:",r)),j(m!==!1)});return}if(b&&s!=="demo"&&a){const r=Ce(a);if(r)return queueMicrotask(()=>{r.distanceKm&&E(r.distanceKm),j(r.isDistanceEditable)}),f.debug("[EditCompensationModal] Using eager-loaded data:",a.convocationCompensation),r.compensationId?Ee(r.compensationId,s,{setReason:k}):void 0;const m=a.refereeGame?.game?.number;if(!m){f.debug("[EditCompensationModal] Assignment has no game number");return}return ke(m,s,g,c,e)}if(y)return ve(y,s,c,e)},[n,y,s,b,a,i,g,e]),p.useEffect(()=>{n||queueMicrotask(()=>{E(""),k(""),_({}),q(null),j(!0),B(!1)})},[n]);const O=p.useCallback(c=>{const r=1+c.successCount;c.failedCount===0?v.success(l("compensations.batchUpdateSuccess",{count:String(r)})):v.warning(l("compensations.batchUpdatePartialSuccess",{success:String(r),total:String(1+c.totalCount),failed:String(c.failedCount)}))},[l]),$=p.useCallback(c=>{const r=M.map(m=>m.convocationCompensation?.__identity).filter(m=>!!m);h.mutate({compensationIds:r,data:{distanceInMetres:c}},{onSuccess:m=>{O(m),t()},onError:m=>{f.error("[EditCompensationModal] Batch update failed:",m),v.warning(l("compensations.batchUpdatePartialSuccess",{success:"1",total:String(1+r.length),failed:String(r.length)})),t()}})},[h,M,O,t,l]),z=p.useCallback(c=>{D&&c.distanceInMetres&&M.length>0?$(c.distanceInMetres):(v.success(e("compensations.saveSuccess")),t())},[D,M.length,$,t,e]),Y=p.useCallback(c=>{c.preventDefault(),_({});const r=ne(C);if(C&&(isNaN(r)||r<0)){_({kilometers:e("assignments.invalidKilometers")});return}const m={};if(C&&(m.distanceInMetres=de(r)),S&&(m.correctionReason=S),Object.keys(m).length===0){t();return}b&&a?x.mutate({assignmentId:a.__identity,data:m},{onSuccess:()=>{f.debug("[EditCompensationModal] Updated assignment compensation"),v.success(e("compensations.saveSuccess")),t()},onError:R=>{f.error("[EditCompensationModal] Failed to update assignment compensation:",R),v.error(e("compensations.saveError"))}}):y&&u.mutate({compensationId:y,data:m},{onSuccess:()=>{f.debug("[EditCompensationModal] Updated compensation"),z(m)},onError:R=>{f.error("[EditCompensationModal] Failed to update compensation:",R),v.error(e("compensations.saveError"))}})},[a,y,C,S,b,x,u,z,t,e]);if(n&&!a&&!d)return f.error("[EditCompensationModal] Modal opened without assignment or compensation"),null;let w=e("common.tbd"),K=e("common.tbd");a?{homeTeam:w,awayTeam:K}=me(a):d&&({homeTeam:w,awayTeam:K}=ue(d));const Q="edit-compensation-title",X=`${w} ${e("common.vs")} ${K}`;return o.jsx(oe,{isOpen:n,onClose:t,titleId:Q,size:"md",isLoading:A,children:o.jsxs(pe,{modalName:"EditCompensationModal",onClose:t,children:[o.jsx(se,{title:e("assignments.editCompensation"),titleId:Q,subtitle:X}),A?o.jsx("div",{className:"flex items-center justify-center py-8",role:"status","aria-live":"polite",children:o.jsx(re,{size:"md"})}):P?o.jsxs("div",{className:"py-6 text-center",role:"alert",children:[o.jsx("p",{className:"text-danger-600 dark:text-danger-400 mb-4",children:P}),o.jsx(L,{variant:"secondary",onClick:t,children:e("common.close")})]}):o.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[o.jsxs("div",{children:[o.jsx("label",{htmlFor:"kilometers",className:"block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-1",children:e("assignments.kilometers")}),o.jsxs("div",{className:"relative",children:[o.jsx("input",{id:"kilometers",type:"text",inputMode:"decimal",pattern:ie,value:C,onChange:c=>E(c.target.value),disabled:!I,className:`w-full px-3 py-2 pr-10 border border-border-strong dark:border-border-strong-dark rounded-md bg-surface-card dark:bg-surface-subtle-dark text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-500 ${I?"":"opacity-50 cursor-not-allowed"}`,"aria-invalid":N.kilometers?"true":"false","aria-describedby":N.kilometers?"kilometers-error":I?void 0:"kilometers-readonly-hint"}),o.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-text-muted dark:text-text-muted-dark text-sm pointer-events-none",children:e("common.distanceUnit")})]}),N.kilometers&&o.jsx("p",{id:"kilometers-error",className:"mt-1 text-sm text-danger-600 dark:text-danger-400",children:N.kilometers}),!I&&o.jsx("p",{id:"kilometers-readonly-hint",className:"mt-1 text-sm text-text-muted dark:text-text-muted-dark",children:e("compensations.distanceNotEditable")})]}),!b&&I&&M.length>0&&H&&o.jsxs("div",{className:"flex items-start gap-3 p-3 bg-surface-subtle dark:bg-surface-subtle-dark rounded-md",children:[o.jsx("input",{id:"apply-to-same-hall",type:"checkbox",checked:D,onChange:c=>B(c.target.checked),"aria-describedby":"apply-to-same-hall-description",className:"mt-0.5 h-4 w-4 rounded border-border-strong dark:border-border-strong-dark text-primary-600 focus:ring-primary-500 focus:ring-2"}),o.jsxs("label",{htmlFor:"apply-to-same-hall",className:"text-sm text-text-secondary dark:text-text-secondary-dark cursor-pointer",children:[o.jsx("span",{className:"block font-medium text-text-primary dark:text-text-primary-dark",children:l("compensations.applyToSameHall",{hallName:H})}),o.jsx("span",{id:"apply-to-same-hall-description",className:"text-text-muted dark:text-text-muted-dark",children:l("compensations.applyToSameHallCount",{count:String(M.length)})})]})]}),o.jsxs("div",{children:[o.jsx("label",{htmlFor:"reason",className:"block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-1",children:e("assignments.reason")}),o.jsx("textarea",{id:"reason",value:S,onChange:c=>k(c.target.value),rows:4,className:"w-full px-3 py-2 border border-border-strong dark:border-border-strong-dark rounded-md bg-surface-card dark:bg-surface-subtle-dark text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-500",placeholder:e("assignments.reasonPlaceholder")})]}),o.jsxs(ce,{children:[o.jsx(L,{variant:"secondary",className:"flex-1",onClick:t,disabled:F,children:e("common.close")}),o.jsx(L,{variant:"primary",className:"flex-1",type:"submit",disabled:F,loading:F,children:e("common.save")})]})]})]})})}const Fe=p.memo(Me);export{Fe as EditCompensationModal};
