# Authentication API

This document describes the authentication flow for the VolleyManager API.

## Overview

VolleyManager uses **cookie-based session authentication** powered by the Neos Flow framework. Authentication involves:

1. Cookie: `Neos_Flow_Session` - Session identifier
1. Cookie: `language` - User's preferred language (fr/de/it)
1. CSRF protection via `__trustedProperties` and `__csrfToken` fields

## Authentication Flow

### 1. Initial Session

When first visiting the site, a session cookie is created:

```http
GET /login HTTP/2
Host: volleymanager.volleyball.ch
```

**Response:**

```http
HTTP/2 200
Set-Cookie: Neos_Flow_Session=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; Path=/; HttpOnly
Content-Type: text/html; charset=UTF-8
```

The login page HTML contains hidden form fields for CSRF protection.

### 2. Login

**Endpoint:** `POST /sportmanager.security/authentication/authenticate`

**Request:**

```http
POST /sportmanager.security/authentication/authenticate HTTP/2
Host: volleymanager.volleyball.ch
Content-Type: application/x-www-form-urlencoded
Cookie: Neos_Flow_Session=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

__referrer[@package]=SportManager.Volleyball&
__referrer[@subpackage]=&
__referrer[@controller]=Public&
__referrer[@action]=login&
__referrer[arguments]=YTowOnt9<hmac-signature-40-chars>&
__trustedProperties=a:0:{}<hmac-signature-40-chars>&
__authentication[Neos][Flow][Security][Authentication][Token][UsernamePassword][username]=my_username&
__authentication[Neos][Flow][Security][Authentication][Token][UsernamePassword][password]=my_password
```

**Success Response (303 Redirect):**

```http
HTTP/2 303
Location: https://volleymanager.volleyball.ch/sportmanager.volleyball/main/dashboard
Set-Cookie: Neos_Flow_Session=yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy; Path=/; HttpOnly
```

**Notes:**

- On success, a **new session cookie** is issued (different from the pre-login session)
- The response redirects to the dashboard
- The old session is invalidated

**Failure Response (200 OK with HTML):**

```http
HTTP/2 200
Content-Type: text/html; charset=UTF-8
Set-Cookie: Neos_Flow_Session=zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz; Path=/; HttpOnly
```

On failure:

- Returns **200 OK** (not a redirect)
- Response body is the **full login page HTML** with an embedded error message
- A **new session cookie** is issued (session rotation happens even on failure)
- Error displayed via Vuetify snackbar component in HTML:
  ```html
  <v-snackbar :value="true" color="error" :timeout="5000">
      Authentifizierung fehlgeschlagen!
  </v-snackbar>
  ```

**Detecting Login Failure:**

- Check for `200` status code (success returns `303`)
- Or check if response body contains `<v-snackbar` with `color="error"`
- Or check if `Location` header is absent

### 3. Authenticated Requests

All subsequent API requests must include the session cookie:

```http
POST /indoorvolleyball.refadmin/api/refereeconvocation/searchMyRefereeConvocations HTTP/2
Host: volleymanager.volleyball.ch
Cookie: Neos_Flow_Session=yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
Content-Type: application/x-www-form-urlencoded

__csrfToken=<token>&searchConfiguration[offset]=0&...
```

### 4. Logout

**Endpoint:** `GET /logout`

**Request:**

```http
GET /logout HTTP/2
Host: volleymanager.volleyball.ch
Cookie: Neos_Flow_Session=yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
```

**Response (303 Redirect):**

```http
HTTP/2 303
Location: https://volleymanager.volleyball.ch/login
```

**Notes:**

- The session is invalidated **server-side**
- No `Set-Cookie` header is sent to clear the cookie
- The client should discard the session cookie after logout

## Request Parameters

### Login Form Fields

| Field | Description | Example |
|-------|-------------|---------|
| `__referrer[@package]` | Referrer package | `SportManager.Volleyball` |
| `__referrer[@subpackage]` | Referrer subpackage | (empty) |
| `__referrer[@controller]` | Referrer controller | `Public` |
| `__referrer[@action]` | Referrer action | `login` |
| `__referrer[arguments]` | Serialized arguments + HMAC | `YTowOnt9...` |
| `__trustedProperties` | CSRF token (serialized + HMAC) | `a:0:{}56fb...` |
| `__authentication[Neos][Flow][Security][Authentication][Token][UsernamePassword][username]` | Username | `my_user` |
| `__authentication[Neos][Flow][Security][Authentication][Token][UsernamePassword][password]` | Password | `my_pass` |

### CSRF Token Format

The `__trustedProperties` field contains a serialized PHP array followed by an HMAC signature:

```
a:0:{}<hmac-signature-40-chars>
```

- `a:0:{}` - Empty PHP array serialized
- `<40-char-hex>` - HMAC-SHA1 signature

This value is generated by the server and embedded in the login form HTML.

## Cookies

| Cookie | Description | Flags |
|--------|-------------|-------|
| `Neos_Flow_Session` | Session identifier (32 chars) | `HttpOnly`, `Path=/` |
| `language` | User's preferred language | `Path=/` |

### Session Cookie Characteristics

- **Length:** 32 characters
- **Characters:** Alphanumeric (a-z, A-Z, 0-9)
- **Example:** `AbCdEfGhIjKlMnOpQrStUvWxYz012345`
- **Lifetime:** Server-controlled (session-based)

## Server Information

From response headers:

- **Framework:** Neos Flow 5.3 (`X-Flow-Powered: Flow/5.3`)
- **Runtime:** PHP 7.4.33
- **Server:** Apache/2.4.54 (Debian)

## Error Handling

### Session Expired

When the session expires, API calls return an error:

```http
HTTP/2 401
Content-Type: application/json

{
  "error": "Session expired. Please log in again."
}
```

### Invalid Credentials

Failed login attempts return **200 OK** with the login page HTML containing an error message.

The error is displayed via a Vuetify snackbar component:

```html
<v-snackbar :value="true" color="error" :timeout="5000">
    Authentifizierung fehlgeschlagen!
</v-snackbar>
```

Note: The error message is in German ("Authentifizierung fehlgeschlagen!" = "Authentication failed!") regardless of the user's language preference.

## Implementation Notes

### For Web Apps

1. **First request**: Make a GET to `/login` to obtain initial session cookie
1. **Parse form**: Extract `__trustedProperties` and `__referrer[arguments]` from HTML
1. **Submit credentials**: POST to `/sportmanager.security/authentication/authenticate`
1. **Follow redirect**: Handle 303 redirect to dashboard (success) or login (failure)
1. **Store session**: Persist `Neos_Flow_Session` cookie for subsequent requests

### For API Clients

Since the CSRF tokens are embedded in HTML, API-only clients need to:

1. Fetch the login page HTML
1. Parse out the hidden form fields
1. Submit the login form with credentials
1. Extract the new session cookie from response headers

### Session Management

- Sessions are server-managed with no explicit expiry in cookies
- The `__csrfToken` parameter is required for all POST/PUT API requests
- Tokens are likely refreshed on each page load (not static)

## Captured From

- **Login HAR:** `login.har` - Captured 2025-12-09 08:39:09
- **Logout HAR:** `logout.har` - Captured 2025-12-09 08:39:50
- **Browser:** Firefox 145.0.2
